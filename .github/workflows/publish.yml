name: publish

on:
  push:
    tags:
      - "v*"

jobs:
  publish-macos:
    permissions:
      contents: write
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: npm
          cache-dependency-path: desktop/package-lock.json

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Cache Rust
        uses: swatinem/rust-cache@v2
        with:
          workspaces: |
            desktop/src-tauri -> target

      - name: Install frontend dependencies
        working-directory: desktop
        run: npm ci

      - name: Desktop tests
        working-directory: desktop
        run: npm test

      - name: Syntax check (canvas_app.js)
        run: node --check desktop/src/canvas_app.js

      - name: Verify tag matches app version
        run: |
          TAG="${GITHUB_REF_NAME}"
          APP_VERSION="$(node -e 'const fs=require("fs"); const cfg=JSON.parse(fs.readFileSync("desktop/src-tauri/tauri.conf.json","utf8")); process.stdout.write(cfg.package.version);')"
          DESKTOP_VERSION="$(node -e 'const fs=require("fs"); const pkg=JSON.parse(fs.readFileSync("desktop/package.json","utf8")); process.stdout.write(pkg.version);')"
          CARGO_VERSION="$(node -e 'const fs=require("fs"); const s=fs.readFileSync("desktop/src-tauri/Cargo.toml","utf8"); const m=s.match(/version\s*=\s*\"([^\"]+)\"/); if(!m) process.exit(2); process.stdout.write(m[1]);')"
          echo "tag=$TAG"
          echo "tauri.conf.json=$APP_VERSION"
          echo "desktop/package.json=$DESKTOP_VERSION"
          echo "desktop/src-tauri/Cargo.toml=$CARGO_VERSION"
          test "$TAG" = "v$APP_VERSION"
          test "$APP_VERSION" = "$DESKTOP_VERSION"
          test "$APP_VERSION" = "$CARGO_VERSION"

      - name: Prepare signing keychain
        run: echo "KEYCHAIN_PASSWORD=$(uuidgen)" >> "$GITHUB_ENV"

      - name: Import Apple Developer Certificate
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ env.KEYCHAIN_PASSWORD }}
        run: |
          echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          # Ensure codesign can find identities in the temporary keychain.
          security list-keychains -d user -s build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          # `-A` prevents "User interaction is not allowed" failures in CI when accessing the private key.
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -A -T /usr/bin/codesign -T /usr/bin/security -T /usr/bin/xcrun
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
          security find-identity -v -p codesigning build.keychain

      - name: Detect signing identity
        run: |
          CERT_INFO="$(security find-identity -v -p codesigning build.keychain | grep -F 'Developer ID Application' | head -n 1 || true)"
          if [ -z "$CERT_INFO" ]; then
            echo "No 'Developer ID Application' identity found in build.keychain"
            exit 1
          fi
          CERT_ID="$(echo "$CERT_INFO" | awk -F'\"' '{print $2}')"
          echo "APPLE_SIGNING_IDENTITY=$CERT_ID" >> "$GITHUB_ENV"
          echo "Using signing identity: $CERT_ID"

      - name: Build and publish (signed + notarized DMG)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Notarization
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          # Some tools expect APPLE_PASSWORD, others APPLE_ID_PASSWORD; set both.
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          # Signing (certificate imported into build.keychain above)
          APPLE_SIGNING_IDENTITY: ${{ env.APPLE_SIGNING_IDENTITY }}
          RUST_BACKTRACE: 1
        with:
          projectPath: desktop
          tagName: ${{ github.ref_name }}
          releaseName: Brood ${{ github.ref_name }}
          releaseBody: |
            See `CHANGELOG.md` for full details.
          generateReleaseNotes: true
          releaseDraft: true
          prerelease: false
          args: --target universal-apple-darwin --ci -v
